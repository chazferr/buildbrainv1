<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BuildBrain</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
    --navy:#0f1923;--navy-mid:#1a2e3d;--navy-border:#263d52;
    --orange:#E87722;--orange-dk:#c9621a;
    --white:#ffffff;--gray-50:#f8f9fa;--gray-100:#f3f4f6;--gray-200:#e5e7eb;
    --gray-400:#9ca3af;--gray-700:#374151;--gray-900:#111827;
    --green:#10b981;--amber:#f59e0b;--red:#ef4444;
    --mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans',system-ui,sans-serif;
}
body{font-family:var(--sans);background:var(--gray-50);color:var(--gray-900);display:flex;flex-direction:row;height:100vh;width:100%;overflow:hidden}

/* ═══ LEFT PANEL ═══ */
.lp{width:30%;min-width:320px;max-width:480px;flex-shrink:0;background:var(--navy);color:rgba(255,255,255,.85);display:flex;flex-direction:column;overflow:hidden}
.lp-brand{padding:1.1rem 1.25rem;display:flex;align-items:center;gap:.6rem;border-bottom:1px solid var(--navy-border);flex-shrink:0}
.lp-logo{width:28px;height:28px;background:var(--orange);border-radius:5px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.9rem;color:var(--white)}
.lp-brand h1{font-size:1.1rem;font-weight:700;letter-spacing:-.02em;color:var(--white)}
.lp-brand h1 span{color:var(--orange)}
.lp-scroll{flex:1;overflow-y:auto;padding:.75rem 1rem}
.lp-section{margin-bottom:1rem}
.lp-section-hdr{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:rgba(255,255,255,.35);margin-bottom:.5rem;display:flex;align-items:center;gap:.4rem}
.lp-section-hdr .badge{background:var(--red);color:var(--white);font-size:.6rem;padding:.1rem .35rem;border-radius:3px;font-weight:700}

/* Dropzone */
.dropzone{border:2px dashed rgba(255,255,255,.12);border-radius:8px;padding:1.5rem .75rem;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:.5rem}
.dropzone:hover,.dropzone.dragover{border-color:var(--orange);background:rgba(232,119,34,.06)}
.dropzone .dz-icon{font-size:2rem;opacity:.3;margin-bottom:.3rem}
.dropzone h2{font-size:.82rem;font-weight:600;color:rgba(255,255,255,.75);margin-bottom:.15rem}
.dropzone p{font-size:.68rem;color:rgba(255,255,255,.3);line-height:1.3}

/* File list */
.file-list{display:flex;flex-direction:column;gap:.3rem}
.file-item{display:flex;align-items:center;gap:.4rem;padding:.35rem .5rem;background:var(--navy-mid);border:1px solid var(--navy-border);border-radius:5px;font-size:.75rem}
.file-item .fi-icon{opacity:.3;font-size:.8rem}
.file-item .fi-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(255,255,255,.75)}
.file-item .fi-size{color:rgba(255,255,255,.3);font-size:.65rem;font-family:var(--mono)}
.file-item .fi-rm{background:none;border:none;color:var(--red);cursor:pointer;font-size:.9rem;opacity:.5;padding:0 .1rem}
.file-item .fi-rm:hover{opacity:1}

/* Buyout */
.buyout-row{display:flex;align-items:center;gap:.4rem;padding:.4rem .5rem;background:var(--navy-mid);border:1.5px dashed rgba(255,255,255,.1);border-radius:6px;cursor:pointer;transition:all .2s;font-size:.75rem;margin-top:.4rem}
.buyout-row:hover{border-color:var(--orange)}
.buyout-row .br-icon{opacity:.35}
.buyout-row .br-label{color:rgba(255,255,255,.5);flex:1}
.buyout-row .br-name{color:var(--green);font-weight:500;font-size:.72rem}
.buyout-row .br-rm{background:none;border:none;color:var(--red);cursor:pointer;font-size:.9rem;opacity:.5}

/* Project status */
.lp-proj-name{font-size:.95rem;font-weight:700;color:var(--white);margin-bottom:.15rem;cursor:text}
.lp-proj-addr{font-size:.72rem;color:rgba(255,255,255,.4);margin-bottom:.5rem}
.status-badge{display:inline-block;padding:.15rem .5rem;border-radius:3px;font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.status-processing{background:rgba(245,158,11,.15);color:var(--amber)}
.status-review{background:rgba(232,119,34,.15);color:var(--orange)}
.status-complete{background:rgba(16,185,129,.15);color:var(--green)}
.lp-progress-text{font-size:.72rem;color:rgba(255,255,255,.45);margin-top:.35rem;font-family:var(--mono)}

/* Confirmed scalars */
.scalar-compact{width:100%}
.scalar-compact tr{border-bottom:1px solid var(--navy-border)}
.scalar-compact td{padding:.25rem 0;font-size:.75rem}
.scalar-compact .sc-label{color:rgba(255,255,255,.45);padding-right:.6rem}
.scalar-compact .sc-val{font-family:var(--mono);font-weight:500;color:rgba(255,255,255,.85)}
.scalar-compact .sc-conf{font-size:.7rem;text-align:right;padding-left:.3rem}
.sc-dot{display:inline-block;width:7px;height:7px;border-radius:50%}
.sc-dot.high{background:var(--green)}.sc-dot.medium{background:var(--amber)}.sc-dot.low{background:var(--gray-400)}
.lp-edit-link{font-size:.72rem;color:var(--orange);cursor:pointer;margin-top:.35rem;display:inline-block}
.lp-edit-link:hover{text-decoration:underline}

/* Confidence */
.conf-pct{font-size:1.4rem;font-weight:700;color:var(--white);font-family:var(--mono);margin-bottom:.4rem}
.conf-bar{display:flex;height:6px;border-radius:3px;overflow:hidden;margin-bottom:.35rem}
.conf-bar .cb-high{background:var(--green)}.conf-bar .cb-medium{background:var(--amber)}.conf-bar .cb-low{background:var(--gray-400)}
.conf-legend{display:flex;gap:.8rem;font-size:.65rem;color:rgba(255,255,255,.45)}
.conf-legend span::before{content:'';display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:.25rem;vertical-align:middle}
.conf-legend .cl-high::before{background:var(--green)}.conf-legend .cl-medium::before{background:var(--amber)}.conf-legend .cl-low::before{background:var(--gray-400)}

/* Flags in sidebar */
.flag-mini{padding:.35rem .5rem;border-left:3px solid var(--gray-400);margin-bottom:.3rem;font-size:.72rem;color:rgba(255,255,255,.6);cursor:pointer;border-radius:0 4px 4px 0;background:rgba(255,255,255,.03);transition:background .15s}
.flag-mini:hover{background:rgba(255,255,255,.06)}
.flag-mini.HIGH{border-left-color:var(--red)}.flag-mini.MEDIUM{border-left-color:var(--amber)}.flag-mini.LOW{border-left-color:#3b82f6}
.flag-mini .fm-sev{font-weight:700;font-size:.62rem;margin-right:.3rem}
.flag-mini .fm-detail{display:none;margin-top:.25rem;font-size:.68rem;color:rgba(255,255,255,.4)}
.flag-mini.expanded .fm-detail{display:block}

/* Actions */
.lp-actions{padding:.75rem 1rem;border-top:1px solid var(--navy-border);flex-shrink:0;display:flex;flex-direction:column;gap:.4rem}
.btn-primary{width:100%;background:var(--orange);color:var(--white);border:none;padding:.6rem;font-size:.85rem;font-weight:600;border-radius:6px;cursor:pointer;font-family:var(--sans);transition:background .15s}
.btn-primary:hover:not(:disabled){background:var(--orange-dk)}.btn-primary:disabled{opacity:.45;cursor:not-allowed}
.btn-ghost{width:100%;background:none;border:1px solid var(--navy-border);color:rgba(255,255,255,.5);padding:.5rem;font-size:.8rem;font-weight:500;border-radius:6px;cursor:pointer;font-family:var(--sans);transition:all .15s}
.btn-ghost:hover{border-color:rgba(255,255,255,.3);color:rgba(255,255,255,.8)}

/* ═══ RIGHT PANEL ═══ */
.rp{flex:1;min-width:0;display:flex;flex-direction:column;overflow:hidden;background:var(--white)}

/* Tab bar */
.tab-bar{display:flex;border-bottom:2px solid var(--gray-200);padding:0 1.5rem;flex-shrink:0;background:var(--white)}
.tab-bar button{background:none;border:none;padding:.7rem 1rem;font-size:.82rem;font-weight:600;color:var(--gray-400);cursor:pointer;border-bottom:2.5px solid transparent;margin-bottom:-2px;font-family:var(--sans);transition:color .15s;position:relative}
.tab-bar button.active{color:var(--gray-900);border-bottom-color:var(--orange)}
.tab-bar button:hover{color:var(--gray-700)}
.tab-bar .tab-dot{position:absolute;top:8px;right:4px;width:6px;height:6px;border-radius:50%;background:var(--orange);display:none}

/* Right panel content */
.rp-body{flex:1;overflow-y:auto}
.rp-state{display:none;height:100%}
.rp-state.active{display:flex;flex-direction:column}
.tab-panel{display:none;padding:1.5rem}
.tab-panel.active{display:block}

/* Idle */
.rp-idle{align-items:center;justify-content:center;text-align:center;padding:3rem;color:var(--gray-400)}
.rp-idle .ri-icon{font-size:3.5rem;opacity:.2;margin-bottom:1rem}
.rp-idle h2{font-size:1.15rem;font-weight:600;color:var(--gray-700);margin-bottom:.35rem}
.rp-idle p{font-size:.88rem;max-width:380px;line-height:1.5}

/* Processing */
.rp-processing{padding:2rem}
.proc-center{text-align:center;margin-bottom:1.5rem}
.proc-logo{font-size:2.5rem;animation:pulse 2s ease-in-out infinite;margin-bottom:.5rem}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}
.proc-title{font-size:1.05rem;font-weight:600;color:var(--gray-900)}
.proc-log{background:var(--gray-900);border-radius:8px;padding:1rem;max-height:380px;overflow-y:auto;font-family:var(--mono);font-size:.75rem;line-height:1.7;color:var(--gray-400)}
.proc-log .pl-text{color:var(--gray-400)}.proc-log .pl-image{color:#60a5fa}
.proc-log .pl-warn{color:var(--amber)}.proc-log .pl-done{color:var(--green)}
.proc-log .pl-summary{color:var(--white);font-weight:600}
.proc-counters{display:flex;gap:1.5rem;margin-top:.75rem;font-size:.75rem;color:var(--gray-400);font-family:var(--mono)}
.proc-counters span b{color:var(--gray-700);font-weight:600}

/* Pre-check */
.rp-precheck{padding:2rem}
.pc-card{background:var(--white);border:2px solid var(--orange);border-radius:10px;padding:1.5rem;max-width:640px;margin:0 auto}
.pc-title{font-size:1.05rem;font-weight:700;color:var(--gray-900);margin-bottom:.2rem}
.pc-sub{font-size:.82rem;color:var(--gray-400);margin-bottom:1rem}
.pc-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.pc-field{display:flex;flex-direction:column;gap:.2rem}
.pc-field.full{grid-column:1/-1}
.pc-field label{font-size:.72rem;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.03em}
.pc-field input,.pc-field select{padding:.45rem .6rem;border:1px solid var(--gray-200);border-radius:5px;font-size:.88rem;font-family:var(--sans);color:var(--gray-900);background:var(--gray-50)}
.pc-field input:focus,.pc-field select:focus{outline:none;border-color:var(--orange)}
.pc-conf{display:inline-block;padding:.12rem .4rem;border-radius:3px;font-size:.7rem;font-weight:600;text-transform:uppercase}
.pc-conf-high{background:#d1fae5;color:#059669}.pc-conf-medium{background:#fef3c7;color:#d97706}.pc-conf-low{background:#fee2e2;color:#dc2626}
.pc-warn{margin-top:.75rem;padding:.5rem .7rem;background:#fef3c7;border:1px solid var(--amber);border-radius:5px;font-size:.78rem;color:#92400e}
.pc-actions{display:flex;gap:.6rem;justify-content:center;margin-top:1.25rem}
.pc-back{background:none;border:1.5px solid var(--gray-200);padding:.6rem 1.25rem;font-size:.88rem;font-weight:500;border-radius:6px;cursor:pointer;color:var(--gray-400);font-family:var(--sans)}
.pc-back:hover{border-color:var(--gray-400);color:var(--gray-700)}

/* ═══ TAB: EXTRACTION ═══ */
.ext-section-title{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--gray-400);margin-bottom:.75rem;margin-top:1.5rem}
.ext-section-title:first-child{margin-top:0}
.ext-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:.75rem}
.ext-card{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:8px;padding:.85rem}
.ext-card-trade{font-weight:600;font-size:.88rem;color:var(--gray-900);margin-bottom:.15rem}
.ext-card-div{font-size:.68rem;color:var(--gray-400);margin-bottom:.4rem}
.ext-card-scope{font-size:.78rem;color:var(--gray-700);line-height:1.4}
.ext-card-scope li{margin-bottom:.1rem}
.ext-card-src{font-size:.65rem;color:var(--gray-400);margin-top:.4rem;font-family:var(--mono)}

/* ═══ TAB: SCALARS ═══ */
.sg-banner{padding:.6rem .85rem;background:#fef3c7;border:1px solid var(--amber);border-radius:6px;font-size:.82rem;color:#92400e;margin-bottom:1rem}
.sg-banner-critical{background:#fee2e2;border-color:var(--red);color:#991b1b}
.sg-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;max-width:680px}
.sg-field{display:flex;flex-direction:column;gap:.2rem}
.sg-field.full{grid-column:1/-1}
.sg-field label{font-size:.72rem;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.03em;display:flex;align-items:center;gap:.35rem}
.sg-field label .sg-conf-badge{font-size:.58rem;padding:.08rem .3rem;border-radius:2px;font-weight:700}
.sg-conf-badge.high{background:#d1fae5;color:#059669}.sg-conf-badge.medium{background:#fef3c7;color:#d97706}.sg-conf-badge.low{background:#fee2e2;color:#dc2626}
.sg-field input,.sg-field select{padding:.45rem .6rem;border:1px solid var(--gray-200);border-radius:5px;font-size:.88rem;font-family:var(--sans);color:var(--gray-900);background:var(--gray-50)}
.sg-field input.low-conf{border-color:var(--red);background:#fff5f5}
.sg-field input:focus,.sg-field select:focus{outline:none;border-color:var(--orange)}
.sg-group-hdr{grid-column:1/-1;font-size:.82rem;font-weight:700;color:var(--gray-900);border-bottom:2px solid var(--gray-200);padding-bottom:.35rem;margin-top:.5rem}
.sg-actions{margin-top:1.25rem}

/* ═══ TAB: PRICING ═══ */
.price-table{width:100%;border-collapse:collapse;font-size:.8rem}
.price-table th{background:var(--gray-900);color:var(--white);padding:.5rem .6rem;text-align:left;font-weight:600;font-size:.72rem;text-transform:uppercase;letter-spacing:.03em;position:sticky;top:0;z-index:2}
.price-table th.col-r{text-align:right}
.price-table td{padding:.45rem .6rem;border-bottom:1px solid var(--gray-200);vertical-align:middle}
.price-table td.money{text-align:right;font-family:var(--mono);font-size:.78rem;white-space:nowrap}
/* Source badges */
.src-badge{display:inline-block;padding:.1rem .35rem;border-radius:3px;font-size:.6rem;font-weight:600;text-transform:uppercase}
.src-calc{background:#dbeafe;color:#2563eb}.src-extract{background:#fef3c7;color:#d97706}.src-quote{background:#d1fae5;color:#059669}.src-placeholder{background:#fee2e2;color:#dc2626}
/* Trade rows */
.ptr-trade td{cursor:pointer}.ptr-trade:hover td{background:var(--gray-50)}
.ptr-trade .pt-expand{color:var(--gray-400);font-size:.7rem;margin-right:.4rem;transition:transform .15s;display:inline-block}
.ptr-trade.expanded .pt-expand{transform:rotate(90deg)}
/* Detail rows */
.ptr-detail{display:none}
.ptr-detail.visible{display:table-row}
.ptr-detail td{padding:0;background:var(--gray-50)}
.detail-inner{padding:.5rem .8rem .5rem 2rem}
.detail-table{width:100%;border-collapse:collapse;font-size:.72rem;margin:0}
.detail-table th{background:var(--gray-200);color:var(--gray-700);padding:.3rem .4rem;font-weight:600;font-size:.65rem;text-transform:uppercase}
.detail-table td{padding:.25rem .4rem;border-bottom:1px solid var(--gray-100)}
.detail-table td.money{text-align:right;font-family:var(--mono)}
/* Section rows */
.ptr-section td{font-weight:700;background:var(--gray-100);border-top:2px solid var(--gray-200)}
.ptr-markup td{font-size:.75rem;color:var(--gray-400);padding-left:2rem;background:var(--gray-50)}
.ptr-total td{background:var(--navy);color:var(--white);font-weight:700;font-size:.88rem}
.ptr-total td.money{font-family:var(--mono);color:var(--white)}
.ptr-site td{font-weight:700;background:#e8f0fe;border-top:2px solid #b8ccf0}
.ptr-grand td{background:var(--gray-900);color:var(--white);font-weight:700;font-size:.92rem}
.ptr-grand td.money{font-family:var(--mono);color:var(--orange);font-size:.95rem}
.ptr-range td{font-size:.78rem;color:var(--gray-400);background:var(--gray-50)}
/* Estimate range bar */
.range-bar{display:flex;align-items:center;gap:.75rem;padding:1rem 0;margin-top:.5rem}
.range-low,.range-high{font-size:.78rem;font-family:var(--mono);color:var(--gray-400);white-space:nowrap}
.range-track{flex:1;height:6px;background:var(--gray-200);border-radius:3px;position:relative}
.range-dot{width:12px;height:12px;background:var(--orange);border-radius:50%;position:absolute;top:-3px;border:2px solid var(--white);box-shadow:0 1px 3px rgba(0,0,0,.2)}

/* ═══ TAB: LINE ITEMS ═══ */
.li-controls{display:flex;gap:.75rem;margin-bottom:1rem}
.li-controls select,.li-controls input{padding:.4rem .6rem;border:1px solid var(--gray-200);border-radius:5px;font-size:.82rem;font-family:var(--sans);color:var(--gray-900)}
.li-controls input{flex:1;max-width:300px}
.li-table{width:100%;border-collapse:collapse;font-size:.78rem}
.li-table th{background:var(--gray-100);color:var(--gray-700);padding:.4rem .5rem;font-weight:600;font-size:.68rem;text-transform:uppercase;text-align:left;position:sticky;top:0;z-index:1}
.li-table th.col-r{text-align:right}
.li-table td{padding:.35rem .5rem;border-bottom:1px solid var(--gray-100);vertical-align:top}
.li-table td.money{text-align:right;font-family:var(--mono);white-space:nowrap}
.li-table tr:hover td{background:var(--gray-50)}

/* ═══ TAB: EXPORT ═══ */
.export-center{max-width:520px;margin:2rem auto;text-align:center}
.export-check{font-size:3rem;margin-bottom:.5rem;opacity:.5}
.export-title{font-size:1.15rem;font-weight:700;color:var(--gray-900);margin-bottom:.2rem}
.export-proj{font-size:.88rem;color:var(--gray-400);margin-bottom:.15rem}
.export-total{font-size:1.4rem;font-weight:700;font-family:var(--mono);color:var(--orange);margin-bottom:1.5rem}
.export-btn{display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 2rem;font-size:.92rem;font-weight:600;border-radius:8px;cursor:pointer;font-family:var(--sans);border:none;transition:all .15s;margin-bottom:.5rem}
.export-btn-primary{background:var(--orange);color:var(--white)}.export-btn-primary:hover{background:var(--orange-dk)}
.export-btn-secondary{background:var(--gray-100);color:var(--gray-700);border:1px solid var(--gray-200)}.export-btn-secondary:hover{background:var(--gray-200)}
.export-desc{font-size:.72rem;color:var(--gray-400);margin-bottom:1.5rem;line-height:1.4}
/* Chat */
.chat-section{text-align:left;margin-top:2rem;border-top:1px solid var(--gray-200);padding-top:1.5rem}
.chat-section h4{font-size:.82rem;font-weight:600;color:var(--gray-700);margin-bottom:.5rem}
.chat-msgs{max-height:250px;overflow-y:auto;display:flex;flex-direction:column;gap:.4rem;margin-bottom:.5rem}
.chat-msg{max-width:88%;padding:.45rem .65rem;border-radius:8px;font-size:.8rem;line-height:1.45;word-wrap:break-word}
.chat-msg.user{background:var(--navy);color:var(--white);align-self:flex-end;border-bottom-right-radius:2px}
.chat-msg.assistant{background:var(--gray-100);color:var(--gray-900);align-self:flex-start;border-bottom-left-radius:2px}
.chat-msg.typing{background:var(--gray-100);color:var(--gray-400);align-self:flex-start;font-style:italic}
.typing-dots::after{content:'';animation:dots 1.2s steps(4,end) infinite}
@keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}}
.chat-row{display:flex;gap:.35rem}
.chat-input{flex:1;border:1px solid var(--gray-200);border-radius:6px;padding:.45rem .6rem;font-size:.82rem;font-family:var(--sans);color:var(--gray-900);resize:none;outline:none;min-height:34px;max-height:80px}
.chat-input:focus{border-color:var(--orange)}
.chat-send{background:var(--orange);color:var(--white);border:none;border-radius:6px;padding:0 .7rem;cursor:pointer;font-size:.95rem}
.chat-send:hover:not(:disabled){background:var(--orange-dk)}.chat-send:disabled{opacity:.35}

/* Error */
.error-card{background:#fef2f2;border:1px solid var(--red);border-radius:8px;padding:1rem;color:#991b1b;margin:1.5rem;display:none}
.error-card.active{display:block}
.error-card a{color:var(--red);cursor:pointer;text-decoration:underline;font-size:.82rem}

/* Utility */
.hidden{display:none!important}
input[type=file]{display:none}
</style>
</head>
<body>

<!-- ═══ LEFT PANEL ═══ -->
<aside class="lp">
    <div class="lp-brand">
        <div class="lp-logo">B</div>
        <h1>Build<span>Brain</span></h1>
    </div>
    <div class="lp-scroll">

        <!-- Upload section -->
        <div class="lp-section" id="lpUpload">
            <div class="lp-section-hdr">Upload</div>
            <div class="dropzone" id="dropzone">
                <div class="dz-icon">&#128466;</div>
                <h2>Drop files here</h2>
                <p>PDF, DOCX, XLSX, CSV, images</p>
                <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.xlsx,.xls,.csv,.eml,.jpg,.jpeg,.png,.tiff,.tif,.bmp,.webp,.txt,.rtf" multiple>
            </div>
            <div class="file-list" id="fileList"></div>
            <div class="buyout-row" id="buyoutRow" title="Reference buyout spreadsheet">
                <span class="br-icon">&#128200;</span>
                <span class="br-label">Reference Buyout (optional)</span>
                <span class="br-name" id="buyoutName"></span>
                <button class="br-rm" id="buyoutRm" style="display:none">&times;</button>
                <input type="file" id="buyoutInput" accept=".xlsx,.xls">
            </div>
        </div>

        <!-- Project Status (replaces upload after processing starts) -->
        <div class="lp-section hidden" id="lpProject">
            <div class="lp-section-hdr">Project</div>
            <div class="lp-proj-name" id="lpProjName">-</div>
            <div class="lp-proj-addr" id="lpProjAddr"></div>
            <span class="status-badge status-processing" id="lpStatusBadge">Processing</span>
            <div class="lp-progress-text" id="lpProgressText"></div>
        </div>

        <!-- Confirmed Scalars -->
        <div class="lp-section hidden" id="lpScalars">
            <div class="lp-section-hdr">Confirmed Scalars</div>
            <table class="scalar-compact" id="lpScalarTable"></table>
            <span class="lp-edit-link" id="lpEditScalars">Edit Scalars</span>
        </div>

        <!-- Extraction Confidence -->
        <div class="lp-section hidden" id="lpConfidence">
            <div class="lp-section-hdr">Extraction Confidence</div>
            <div class="conf-pct" id="lpConfPct">--%</div>
            <div class="conf-bar" id="lpConfBar"></div>
            <div class="conf-legend" id="lpConfLegend"></div>
        </div>

        <!-- Flags -->
        <div class="lp-section hidden" id="lpFlags">
            <div class="lp-section-hdr">Flags <span class="badge hidden" id="lpFlagBadge">0</span></div>
            <div id="lpFlagList" style="max-height:200px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- Actions -->
    <div class="lp-actions" id="lpActions">
        <button class="btn-primary" id="btnAnalyze" style="display:none">Analyze Documents</button>
        <button class="btn-primary hidden" id="btnRerun">Re-run Pricing</button>
        <button class="btn-ghost hidden" id="btnNewProject">New Project</button>
    </div>
</aside>

<!-- ═══ RIGHT PANEL ═══ -->
<main class="rp">
    <!-- Tab bar -->
    <div class="tab-bar hidden" id="tabBar">
        <button data-tab="extraction">Extraction</button>
        <button data-tab="scalars">Scalars<span class="tab-dot"></span></button>
        <button data-tab="pricing" class="active">Pricing</button>
        <button data-tab="lineitems">Line Items</button>
        <button data-tab="export">Export</button>
    </div>

    <div class="rp-body" id="rpBody">
        <!-- Idle -->
        <div class="rp-state rp-idle active" id="rpIdle">
            <div class="ri-icon">&#128736;</div>
            <h2>Ready to estimate</h2>
            <p>Upload construction documents in the left panel, then click Analyze to generate a detailed cost estimate.</p>
        </div>

        <!-- Pre-check -->
        <div class="rp-state rp-precheck" id="rpPrecheck">
            <div class="pc-card">
                <div class="pc-title">Project Pre-Check</div>
                <div class="pc-sub">Review detected project info before running full analysis.</div>
                <div class="pc-grid">
                    <div class="pc-field full"><label>Project Name</label><input type="text" id="pc_project_name" placeholder="Not detected"></div>
                    <div class="pc-field full"><label>Project Address</label><input type="text" id="pc_project_address" placeholder="Not detected"></div>
                    <div class="pc-field"><label>Project Type</label>
                        <select id="pc_project_type"><option value="single_family">Single Family</option><option value="multi_family">Multi-Family</option><option value="commercial">Commercial</option><option value="mixed_use">Mixed Use</option><option value="unknown">Unknown</option></select></div>
                    <div class="pc-field"><label>Construction Type</label>
                        <select id="pc_construction_type"><option value="new_construction">New Construction</option><option value="renovation">Renovation (1.35x)</option><option value="gut_rehabilitation">Gut Rehabilitation (1.55x)</option><option value="addition">Addition (1.20x)</option><option value="unknown">Unknown</option></select></div>
                    <div class="pc-field"><label>Unit Count</label><input type="number" id="pc_unit_count" min="1" placeholder="--"></div>
                    <div class="pc-field"><label>Floor Count</label><input type="number" id="pc_floor_count" min="1" placeholder="--"></div>
                    <div class="pc-field"><label>Total Building SF</label><input type="number" id="pc_total_building_sf" min="1" placeholder="--"></div>
                    <div class="pc-field"><label>Confidence</label><span class="pc-conf" id="pc_confidence">--</span></div>
                </div>
                <div class="pc-warn hidden" id="pc_warning"></div>
                <div class="pc-actions">
                    <button class="pc-back" id="pcBack">Back</button>
                    <button class="btn-primary" id="pcConfirm" style="width:auto;padding:.6rem 1.5rem">Confirm &amp; Analyze</button>
                </div>
            </div>
        </div>

        <!-- Processing -->
        <div class="rp-state rp-processing" id="rpProcessing">
            <div class="proc-center">
                <div class="proc-logo">&#128736;</div>
                <div class="proc-title">Reading your documents...</div>
            </div>
            <div class="proc-log" id="procLog"></div>
            <div class="proc-counters" id="procCounters">
                <span><b id="cntPages">0</b> pages processed</span>
                <span><b id="cntTrades">0</b> trades found</span>
            </div>
        </div>

        <!-- Tab panels -->
        <div class="tab-panel" id="tab-extraction"></div>
        <div class="tab-panel" id="tab-scalars"></div>
        <div class="tab-panel" id="tab-pricing"></div>
        <div class="tab-panel" id="tab-lineitems"></div>
        <div class="tab-panel" id="tab-export"></div>

        <!-- Error -->
        <div class="error-card" id="errorCard">
            <strong>Error:</strong> <span id="errorMsg"></span><br>
            <a id="errorRetry">Try again</a>
        </div>
    </div>
</main>

<script>
(function(){
/* ─── State ─── */
let selectedFiles=[], buyoutFile=null, currentJobId=null, confirmedPrecheck=null, chatBusy=false;
let _scalarData=null, _resultsData=null;
let _procPages=0, _procTrades=0;

/* ─── Elements ─── */
const $=id=>document.getElementById(id);
const dropzone=$('dropzone'), fileInput=$('fileInput'), fileList=$('fileList');
const buyoutRow=$('buyoutRow'), buyoutInput=$('buyoutInput'), buyoutName=$('buyoutName'), buyoutRm=$('buyoutRm');
const lpUpload=$('lpUpload'), lpProject=$('lpProject'), lpScalars=$('lpScalars'), lpConfidence=$('lpConfidence'), lpFlags=$('lpFlags');
const lpProjName=$('lpProjName'), lpProjAddr=$('lpProjAddr'), lpStatusBadge=$('lpStatusBadge'), lpProgressText=$('lpProgressText');
const btnAnalyze=$('btnAnalyze'), btnRerun=$('btnRerun'), btnNewProject=$('btnNewProject');
const tabBar=$('tabBar'), rpBody=$('rpBody');
const rpIdle=$('rpIdle'), rpPrecheck=$('rpPrecheck'), rpProcessing=$('rpProcessing');
const procLog=$('procLog'), cntPages=$('cntPages'), cntTrades=$('cntTrades');
const errorCard=$('errorCard'), errorMsg=$('errorMsg'), errorRetry=$('errorRetry');

/* ─── Drag & Drop ─── */
dropzone.addEventListener('click',()=>fileInput.click());
dropzone.addEventListener('dragover',e=>{e.preventDefault();dropzone.classList.add('dragover')});
dropzone.addEventListener('dragleave',()=>dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop',e=>{e.preventDefault();dropzone.classList.remove('dragover');
    const ok=['.pdf','.docx','.doc','.xlsx','.xls','.csv','.eml','.jpg','.jpeg','.png','.tiff','.tif','.bmp','.webp','.txt','.rtf'];
    addFiles(Array.from(e.dataTransfer.files).filter(f=>ok.includes('.'+f.name.split('.').pop().toLowerCase())));
});
fileInput.addEventListener('change',()=>{addFiles(Array.from(fileInput.files));fileInput.value=''});

/* Buyout */
buyoutRow.addEventListener('click',e=>{if(e.target!==buyoutRm)buyoutInput.click()});
buyoutInput.addEventListener('change',()=>{if(buyoutInput.files.length){buyoutFile=buyoutInput.files[0];buyoutName.textContent=buyoutFile.name;buyoutRm.style.display=''}buyoutInput.value=''});
buyoutRm.addEventListener('click',e=>{e.stopPropagation();buyoutFile=null;buyoutName.textContent='';buyoutRm.style.display='none'});

function addFiles(files){
    for(const f of files)if(!selectedFiles.some(s=>s.name===f.name&&s.size===f.size))selectedFiles.push(f);
    renderFileList();
}
function renderFileList(){
    fileList.innerHTML='';
    selectedFiles.forEach((f,i)=>{
        const sz=f.size>1048576?(f.size/1048576).toFixed(1)+' MB':(f.size/1024).toFixed(0)+' KB';
        const d=document.createElement('div');d.className='file-item';
        d.innerHTML=`<span class="fi-icon">&#128196;</span><span class="fi-name">${esc(f.name)}</span><span class="fi-size">${sz}</span><button class="fi-rm" data-i="${i}">&times;</button>`;
        fileList.appendChild(d);
    });
    fileList.querySelectorAll('.fi-rm').forEach(b=>b.addEventListener('click',e=>{selectedFiles.splice(+e.target.dataset.i,1);renderFileList()}));
    btnAnalyze.style.display=selectedFiles.length?'':'none';
}

/* ─── State transitions ─── */
function showRpState(id){
    document.querySelectorAll('.rp-state').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    if(id)document.getElementById(id).classList.add('active');
}
function showTab(name){
    showRpState(null);
    tabBar.classList.remove('hidden');
    document.querySelectorAll('.tab-bar button').forEach(b=>{b.classList.toggle('active',b.dataset.tab===name)});
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    const panel=$('tab-'+name);if(panel)panel.classList.add('active');
}

/* Tab click */
tabBar.addEventListener('click',e=>{const b=e.target.closest('button[data-tab]');if(b)showTab(b.dataset.tab)});

/* ─── Pre-check ─── */
btnAnalyze.addEventListener('click',async()=>{
    if(!selectedFiles.length)return;
    const hasPDFs=selectedFiles.some(f=>f.name.toLowerCase().endsWith('.pdf'));
    if(!hasPDFs){runFullUpload();return}
    btnAnalyze.disabled=true;btnAnalyze.textContent='Scanning...';
    try{
        const fd=new FormData();selectedFiles.forEach(f=>{if(f.name.toLowerCase().endsWith('.pdf'))fd.append('pdfs',f)});
        const r=await fetch('/api/pre-check',{method:'POST',body:fd});const d=await r.json();
        if(d.error&&!d.project_name){btnAnalyze.disabled=false;btnAnalyze.textContent='Analyze Documents';runFullUpload();return}
        populatePrecheck(d);showRpState('rpPrecheck');tabBar.classList.add('hidden');
    }catch(e){btnAnalyze.disabled=false;btnAnalyze.textContent='Analyze Documents';runFullUpload()}
});

function populatePrecheck(d){
    $('pc_project_name').value=d.project_name||'';$('pc_project_address').value=d.project_address||'';
    $('pc_project_type').value=d.project_type||'unknown';$('pc_construction_type').value=d.construction_type||'unknown';
    $('pc_unit_count').value=d.unit_count||'';$('pc_floor_count').value=d.floor_count||'';$('pc_total_building_sf').value=d.total_building_sf||'';
    const c=(d.confidence||'low').toLowerCase();const el=$('pc_confidence');el.textContent=c;el.className='pc-conf pc-conf-'+c;
    const w=$('pc_warning');if(d.complexity_warning){w.textContent=d.complexity_warning;w.classList.remove('hidden')}else w.classList.add('hidden');
}
function readPrecheckValues(){return{
    confirmed_project_name:$('pc_project_name').value,confirmed_project_address:$('pc_project_address').value,
    confirmed_project_type:$('pc_project_type').value,confirmed_construction_type:$('pc_construction_type').value,
    confirmed_unit_count:$('pc_unit_count').value,confirmed_floor_count:$('pc_floor_count').value,
    confirmed_total_building_sf:$('pc_total_building_sf').value
}}
$('pcBack').addEventListener('click',()=>{showRpState('rpIdle');tabBar.classList.add('hidden');btnAnalyze.disabled=false;btnAnalyze.textContent='Analyze Documents'});
$('pcConfirm').addEventListener('click',()=>{confirmedPrecheck=readPrecheckValues();runFullUpload()});

/* ─── Full Upload + SSE ─── */
async function runFullUpload(){
    showRpState('rpProcessing');tabBar.classList.add('hidden');
    lpUpload.classList.add('hidden');lpProject.classList.remove('hidden');
    lpStatusBadge.textContent='PROCESSING';lpStatusBadge.className='status-badge status-processing';
    lpProjName.textContent=confirmedPrecheck?confirmedPrecheck.confirmed_project_name||'Processing...':'Processing...';
    lpProjAddr.textContent='';lpProgressText.textContent='';
    procLog.innerHTML='';_procPages=0;_procTrades=0;cntPages.textContent='0';cntTrades.textContent='0';
    btnAnalyze.style.display='none';

    addProcEntry('Uploading files...','text');
    const fd=new FormData();selectedFiles.forEach(f=>fd.append('pdfs',f));
    if(buyoutFile)fd.append('buyout',buyoutFile);
    if(confirmedPrecheck)for(const[k,v]of Object.entries(confirmedPrecheck))if(v)fd.append(k,v);

    try{
        const r=await fetch('/api/upload',{method:'POST',body:fd});const d=await r.json();
        if(!r.ok)throw new Error(d.error||'Upload failed');
        currentJobId=d.job_id;addProcEntry('Upload complete. Starting extraction...','done');
        const es=new EventSource('/api/stream/'+currentJobId);
        es.addEventListener('progress',e=>{const d=JSON.parse(e.data);addProcEntry(d.message);parseProcCounters(d.message)});
        es.addEventListener('scalars_ready',e=>{const d=JSON.parse(e.data);_scalarData=d;onScalarsReady(d)});
        es.addEventListener('done',e=>{es.close();onDone(JSON.parse(e.data))});
        es.addEventListener('error',e=>{if(e.data){es.close();showError(JSON.parse(e.data).error)}else es.close()});
        es.onerror=()=>es.close();
    }catch(e){showError(e.message)}
}

function addProcEntry(text,type){
    const cls=text.includes('[IMAGE]')||text.includes('[VISION]')?'pl-image':
              text.includes('WARNING')||text.includes('⚠')?'pl-warn':
              text.includes('✓')||text.includes('complete')?'pl-done':
              type==='done'?'pl-done':type==='summary'?'pl-summary':'pl-text';
    const d=document.createElement('div');d.className=cls;d.textContent=text;
    procLog.appendChild(d);procLog.scrollTop=procLog.scrollHeight;
    lpProgressText.textContent=text.substring(0,60);
}
function parseProcCounters(msg){
    const pm=msg.match(/page\s+(\d+)/i);if(pm){_procPages=Math.max(_procPages,+pm[1]);cntPages.textContent=_procPages}
    const tm=msg.match(/(\d+)\s+trades/i);if(tm){_procTrades=Math.max(_procTrades,+tm[1]);cntTrades.textContent=_procTrades}
    if(msg.match(/\d+\s+pages/i)){const m2=msg.match(/(\d+)\s+pages/i);if(m2)cntPages.textContent=m2[1]}
}

/* ─── Scalar Gate → Scalars Tab ─── */
const _SEL_OPTS={
    project_type:[{v:'single_family',l:'Single Family'},{v:'multi_family',l:'Multi-Family'},{v:'commercial',l:'Commercial'},{v:'mixed_use',l:'Mixed Use'},{v:'unknown',l:'Unknown'}],
    construction_type:[{v:'new_construction',l:'New Construction'},{v:'renovation',l:'Renovation (1.35x)'},{v:'gut_rehabilitation',l:'Gut Rehabilitation (1.55x)'},{v:'addition',l:'Addition (1.20x)'},{v:'unknown',l:'Unknown'}]
};

function onScalarsReady(data){
    lpStatusBadge.textContent='REVIEW';lpStatusBadge.className='status-badge status-review';
    // Build Scalars tab
    buildScalarsTab(data);
    // Show tab bar, switch to Scalars
    showTab('scalars');
}

function buildScalarsTab(data){
    let h='';
    if(data.tsf_missing_warning) h+=`<div class="sg-banner sg-banner-critical">${esc(data.tsf_missing_warning)}</div>`;
    else if(data.gate_required) h+='<div class="sg-banner">One or more values have low confidence. Please verify before generating.</div>';
    else if(data.complexity_warning) h+=`<div class="sg-banner">${esc(data.complexity_warning)}</div>`;

    h+='<div class="sg-grid" id="sgGrid">';
    const fullKeys=['project_name','project_address'];
    const mainS=data.scalars.filter(s=>!s.group),gcS=data.scalars.filter(s=>s.group==='gc_markup'),siteS=data.scalars.filter(s=>s.group==='site_work');

    function field(s){
        const fw=fullKeys.includes(s.key)?' full':'';
        const lo=s.confidence==='low'?' low-conf':'';
        const badge=`<span class="sg-conf-badge ${s.confidence}">${s.confidence}</span>`;
        let inp;
        if(_SEL_OPTS[s.key]){
            const opts=_SEL_OPTS[s.key].map(o=>`<option value="${o.v}"${o.v===String(s.value)?' selected':''}>${o.l}</option>`).join('');
            inp=`<select data-key="${s.key}"${lo?' class="low-conf"':''}>${opts}</select>`;
        }else if(s.type==='float') inp=`<input type="number" data-key="${s.key}" class="${lo}" value="${s.value}" min="0" step="0.1" placeholder="--">`;
        else if(s.type==='number') inp=`<input type="number" data-key="${s.key}" class="${lo}" value="${s.value}" min="0" placeholder="--">`;
        else inp=`<input type="text" data-key="${s.key}" class="${lo}" value="${esc(String(s.value))}" placeholder="--">`;
        return `<div class="sg-field${fw}"><label>${esc(s.label)} ${badge}</label>${inp}</div>`;
    }
    mainS.forEach(s=>{h+=field(s)});
    if(gcS.length){h+='<div class="sg-group-hdr">GC Markup</div>';gcS.forEach(s=>{h+=field(s)})}
    if(siteS.length){h+='<div class="sg-group-hdr">Site Work</div>';siteS.forEach(s=>{h+=field(s)})}
    h+='</div>';
    h+='<div class="sg-actions"><button class="btn-primary" id="sgConfirm" style="width:auto;padding:.6rem 2rem">Confirm Scalars &amp; Update Pricing</button></div>';
    $('tab-scalars').innerHTML=h;
    $('sgConfirm').addEventListener('click',confirmScalars);
}

async function confirmScalars(){
    const scalars={};$('tab-scalars').querySelectorAll('[data-key]').forEach(el=>{scalars[el.dataset.key]=el.value});
    showRpState('rpProcessing');tabBar.classList.add('hidden');
    addProcEntry('Generating Excel with confirmed values...','text');
    lpStatusBadge.textContent='PROCESSING';lpStatusBadge.className='status-badge status-processing';
    try{
        const r=await fetch('/api/confirm-scalars',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({job_id:currentJobId,scalars})});
        if(!r.ok){const e=await r.json();showError(e.error||'Failed to confirm')}
    }catch(e){showError(e.message)}
}

/* ─── Done → Build all tabs ─── */
function onDone(stats){
    lpStatusBadge.textContent='COMPLETE';lpStatusBadge.className='status-badge status-complete';
    lpProgressText.textContent='';
    fetch('/api/results/'+currentJobId).then(r=>r.json()).then(data=>{
        _resultsData=data;
        updateLeftPanel(data);
        buildExtractionTab(data);
        buildPricingTab(data);
        buildLineItemsTab(data);
        buildExportTab(data,stats);
        // If scalars tab not yet built from _scalarData, build read-only
        if(!_scalarData)buildReadOnlyScalarsTab(data);
        showTab('pricing');
        // Show action buttons
        btnRerun.classList.remove('hidden');btnNewProject.classList.remove('hidden');
    }).catch(e=>console.error('Results error:',e));
}

/* ─── Update Left Panel after results ─── */
function updateLeftPanel(data){
    const gs=k=>{const s=(data.scalars||[]).find(x=>x.key===k);return s?String(s.value||''):''};
    const tc=s=>s.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    lpProjName.textContent=gs('project_name')||'Untitled Project';
    lpProjAddr.textContent=gs('project_address')||'';

    // Confirmed scalars
    const scKeys=[['unit_count','Units'],['floor_count','Floors'],['total_building_sf','Total SF'],['project_type','Type'],['construction_type','Construction']];
    let shtml='';
    scKeys.forEach(([k,lbl])=>{
        const s=(data.scalars||[]).find(x=>x.key===k);
        const v=s?String(s.value||'\u2014'):'\u2014';const c=s?s.confidence:'low';
        const dv=k==='total_building_sf'&&v!=='\u2014'?Number(v).toLocaleString()+' SF':
                 (k==='project_type'||k==='construction_type')?tc(v):v;
        shtml+=`<tr><td class="sc-label">${lbl}</td><td class="sc-val">${esc(dv)}</td><td class="sc-conf"><span class="sc-dot ${c}"></span></td></tr>`;
    });
    $('lpScalarTable').innerHTML=shtml;lpScalars.classList.remove('hidden');

    // Confidence
    const allConf=(data.scalars||[]).map(s=>s.confidence);
    const hi=allConf.filter(c=>c==='high').length,med=allConf.filter(c=>c==='medium').length,lo=allConf.filter(c=>c==='low').length;
    const total=hi+med+lo||1;
    const pct=Math.round((hi*1+med*.5)/total*100);
    $('lpConfPct').textContent=pct+'% confidence';
    $('lpConfBar').innerHTML=`<div class="cb-high" style="width:${hi/total*100}%"></div><div class="cb-medium" style="width:${med/total*100}%"></div><div class="cb-low" style="width:${lo/total*100}%"></div>`;
    $('lpConfLegend').innerHTML=`<span class="cl-high">HIGH ${hi}</span><span class="cl-medium">MEDIUM ${med}</span><span class="cl-low">LOW ${lo}</span>`;
    lpConfidence.classList.remove('hidden');

    // Flags
    const flags=data.flags||[];
    const highCount=flags.filter(f=>f.severity==='HIGH').length;
    const badge=$('lpFlagBadge');
    if(highCount){badge.textContent=highCount;badge.classList.remove('hidden')}
    let fhtml='';flags.forEach(f=>{
        fhtml+=`<div class="flag-mini ${f.severity||''}" onclick="this.classList.toggle('expanded')">
            <span class="fm-sev">${f.severity||'INFO'}</span>${esc(f.flag||'')}
            <div class="fm-detail">${esc(f.detail||'')}</div></div>`;
    });
    $('lpFlagList').innerHTML=fhtml||'<div style="font-size:.72rem;color:rgba(255,255,255,.3)">No flags</div>';
    lpFlags.classList.remove('hidden');
}

/* Edit scalars link */
$('lpEditScalars').addEventListener('click',()=>{if(_scalarData)buildScalarsTab(_scalarData);showTab('scalars')});

/* ─── Tab: Extraction ─── */
function buildExtractionTab(data){
    let h='<div class="ext-section-title">Trades Detected</div><div class="ext-cards">';
    (data.scope_details||[]).forEach(sd=>{
        const items=(sd.scope_items||[]).slice(0,3).map(s=>'<li>'+esc(s)+'</li>').join('');
        const more=sd.scope_items.length>3?`<li style="color:var(--gray-400)">+${sd.scope_items.length-3} more...</li>`:'';
        h+=`<div class="ext-card"><div class="ext-card-trade">${esc(sd.trade)}</div><div class="ext-card-div">CSI ${esc(sd.div)}</div><ul class="ext-card-scope">${items}${more}</ul></div>`;
    });
    h+='</div>';
    $('tab-extraction').innerHTML=h;
}

/* ─── Tab: Pricing ─── */
function buildPricingTab(data){
    const t=data.totals||{},divs=data.divisions||[];
    window._bbData=data;
    let h='<div style="overflow-x:auto"><table class="price-table" id="priceTable"><thead><tr>';
    h+='<th>Trade</th><th>Source</th><th class="col-r">Total</th><th class="col-r">Conf</th></tr></thead><tbody>';

    divs.forEach((div,di)=>{
        div.rows.forEach((row,ri)=>{
            const srcClass=row.source_note?.includes('rate_table')?'src-calc':
                           row.source_note?.includes('material_db')?'src-extract':
                           row.source_note?.includes('placeholder')?'src-placeholder':'src-calc';
            const srcLabel=row.source_note?.includes('rate_table')?'RATE':
                           row.source_note?.includes('material_db')?'MATERIAL':
                           row.source_note?.includes('placeholder')?'PLACEHOLDER':
                           row.source_note?.includes('calculated')?'CALC':'CALC';
            const conf=row.confidence||'medium';
            h+=`<tr class="ptr-trade" data-div="${di}" data-row="${ri}">`;
            h+=`<td><span class="pt-expand">&#9654;</span><span style="color:var(--gray-400);font-size:.68rem;margin-right:.4rem">${esc(row.cost_code)}</span>${esc(row.trade)}</td>`;
            h+=`<td><span class="src-badge ${srcClass}">${srcLabel}</span></td>`;
            h+=`<td class="money">${fmt(row.original_budget)}</td>`;
            h+=`<td><span class="sc-dot ${conf}"></span></td></tr>`;
            // Detail row (hidden)
            h+=`<tr class="ptr-detail" data-div="${di}" data-row="${ri}"><td colspan="4"><div class="detail-inner">`;
            if(row.line_items&&row.line_items.length){
                h+='<table class="detail-table"><thead><tr><th>Work Item</th><th class="col-r">Qty</th><th>Unit</th><th class="col-r">Total</th><th>Source</th></tr></thead><tbody>';
                row.line_items.forEach(li=>{
                    h+=`<tr><td>${esc(li.item||'')}</td><td class="money">${li.qty||''}</td><td>${esc(li.unit||'')}</td><td class="money">${fmt(li.total)}</td><td style="font-size:.65rem;color:var(--gray-400)">${esc(li.source||'')}</td></tr>`;
                });
                h+='</tbody></table>';
            }else h+='<div style="font-size:.75rem;color:var(--gray-400)">No line item detail available</div>';
            h+='</div></td></tr>';
        });
    });

    // Summary rows
    h+=`<tr class="ptr-section"><td colspan="2">BUILDING SUBTOTAL</td><td class="money" id="sum-bldg-sub">${fmt(t.building_subtotal)}</td><td></td></tr>`;
    h+=`<tr class="ptr-markup"><td colspan="2">GC Conditions (${(t.gc_conditions_pct*100).toFixed(1)}%)</td><td class="money">${fmt(t.gc_conditions)}</td><td></td></tr>`;
    h+=`<tr class="ptr-markup"><td colspan="2">GC Profit (${(t.gc_profit_pct*100).toFixed(1)}%)</td><td class="money">${fmt(t.gc_profit)}</td><td></td></tr>`;
    h+=`<tr class="ptr-markup"><td colspan="2">Contingency (${(t.contingency_pct*100).toFixed(1)}%)</td><td class="money">${fmt(t.contingency)}</td><td></td></tr>`;
    h+=`<tr class="ptr-markup"><td colspan="2">Permits + Bond (${(t.permits_pct*100).toFixed(1)}%)</td><td class="money">${fmt(t.permits)}</td><td></td></tr>`;
    h+=`<tr class="ptr-total"><td colspan="2">BUILDING TOTAL</td><td class="money">${fmt(t.building_total)}</td><td></td></tr>`;
    h+=`<tr class="ptr-site"><td colspan="2">SITE TOTAL</td><td class="money">${fmt(t.site_total)}</td><td></td></tr>`;
    h+=`<tr class="ptr-grand"><td colspan="2">PROJECT TOTAL</td><td class="money">${fmt(t.project_total)}</td><td></td></tr>`;
    h+='</tbody></table></div>';

    // Range bar
    const lo=t.low_estimate||t.project_total*.85, hi=t.high_estimate||t.project_total*1.15;
    const pct=t.project_total?Math.round((t.project_total-lo)/(hi-lo)*100):50;
    h+=`<div class="range-bar"><span class="range-low">${fmt(lo)}</span><div class="range-track"><div class="range-dot" style="left:calc(${pct}% - 6px)"></div></div><span class="range-high">${fmt(hi)}</span></div>`;

    $('tab-pricing').innerHTML=h;

    // Expand/collapse trade rows
    document.querySelectorAll('.ptr-trade').forEach(tr=>{
        tr.addEventListener('click',()=>{
            const di=tr.dataset.div,ri=tr.dataset.row;
            tr.classList.toggle('expanded');
            const detail=document.querySelector(`.ptr-detail[data-div="${di}"][data-row="${ri}"]`);
            if(detail)detail.classList.toggle('visible');
        });
    });
}

/* ─── Tab: Line Items ─── */
function buildLineItemsTab(data){
    const divs=data.divisions||[];
    // Collect all trades for filter
    const tradeNames=['All Trades'];
    divs.forEach(d=>d.rows.forEach(r=>{if(!tradeNames.includes(r.trade))tradeNames.push(r.trade)}));
    let h='<div class="li-controls"><select id="liFilter">'+tradeNames.map(t=>`<option>${esc(t)}</option>`).join('')+'</select>';
    h+='<input type="text" id="liSearch" placeholder="Search work items..."></div>';
    h+='<div style="overflow-x:auto;max-height:calc(100vh - 160px);overflow-y:auto"><table class="li-table" id="liTable"><thead><tr>';
    h+='<th>Trade</th><th>Work Item</th><th class="col-r">Qty</th><th>Unit</th><th class="col-r">Total</th><th>Source</th></tr></thead><tbody>';

    divs.forEach(d=>d.rows.forEach(r=>{
        if(r.line_items&&r.line_items.length){
            r.line_items.forEach(li=>{
                h+=`<tr data-trade="${esc(r.trade)}"><td>${esc(r.trade)}</td><td>${esc(li.item||'')}</td><td class="money">${li.qty||''}</td><td>${esc(li.unit||'')}</td><td class="money">${fmt(li.total)}</td><td style="font-size:.68rem;color:var(--gray-400)">${esc(li.source||'')}</td></tr>`;
            });
        }else{
            h+=`<tr data-trade="${esc(r.trade)}"><td>${esc(r.trade)}</td><td style="color:var(--gray-400)">Lump sum</td><td class="money"></td><td></td><td class="money">${fmt(r.original_budget)}</td><td style="font-size:.68rem;color:var(--gray-400)">${esc(r.source_note||'')}</td></tr>`;
        }
    }));
    h+='</tbody></table></div>';
    $('tab-lineitems').innerHTML=h;

    // Filter & search
    const filterEl=$('liFilter'),searchEl=$('liSearch');
    function applyFilter(){
        const trade=filterEl.value,q=searchEl.value.toLowerCase();
        document.querySelectorAll('#liTable tbody tr').forEach(tr=>{
            const matchTrade=trade==='All Trades'||tr.dataset.trade===trade;
            const matchSearch=!q||tr.textContent.toLowerCase().includes(q);
            tr.style.display=matchTrade&&matchSearch?'':'none';
        });
    }
    filterEl.addEventListener('change',applyFilter);
    searchEl.addEventListener('input',applyFilter);
}

/* ─── Tab: Export ─── */
function buildExportTab(data,stats){
    const gs=k=>{const s=(data.scalars||[]).find(x=>x.key===k);return s?String(s.value||''):''};
    const t=data.totals||{};
    let h=`<div class="export-center">
        <div class="export-check">&#9989;</div>
        <div class="export-title">Your estimate is ready.</div>
        <div class="export-proj">${esc(gs('project_name')||'Untitled Project')}</div>
        <div class="export-total">${fmt(t.project_total)}</div>
        <button class="export-btn export-btn-primary" id="dlExcel">&#11015; Download Excel Workbook</button>
        <div class="export-desc">6 tabs: Buyout Summary, Scope Details, Submission Requirements, Source Trace, Calculation Detail, Project Scalars</div>
        <div class="chat-section">
            <h4>Ask BuildBrain</h4>
            <div class="chat-msgs" id="chatMsgs"></div>
            <div class="chat-row">
                <textarea class="chat-input" id="chatInput" placeholder="Ask about your estimate..." rows="1"></textarea>
                <button class="chat-send" id="chatSend">&#9654;</button>
            </div>
        </div>
    </div>`;
    $('tab-export').innerHTML=h;
    $('dlExcel').addEventListener('click',()=>{if(currentJobId)window.location.href='/api/download/'+currentJobId});
    $('chatSend').addEventListener('click',sendQuestion);
    $('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendQuestion()}});
    $('chatInput').addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,80)+'px'});
}

/* Read-only scalars if no scalar gate data */
function buildReadOnlyScalarsTab(data){
    let h='<div class="sg-grid">';
    (data.scalars||[]).forEach(s=>{
        const badge=`<span class="sg-conf-badge ${s.confidence}">${s.confidence}</span>`;
        const v=typeof s.value==='number'?s.value.toLocaleString():String(s.value||'\u2014');
        h+=`<div class="sg-field"><label>${esc(s.label)} ${badge}</label><input type="text" value="${esc(v)}" readonly style="background:var(--gray-100);cursor:default"></div>`;
    });
    h+='</div>';$('tab-scalars').innerHTML=h;
}

/* ─── Chat ─── */
async function sendQuestion(){
    const inp=$('chatInput'),msgs=$('chatMsgs');
    const q=inp.value.trim();if(!q||chatBusy)return;
    chatBusy=true;$('chatSend').disabled=true;inp.value='';
    addChat(q,'user');
    const typ=document.createElement('div');typ.className='chat-msg typing';typ.id='typInd';typ.innerHTML='Thinking<span class="typing-dots"></span>';msgs.appendChild(typ);msgs.scrollTop=msgs.scrollHeight;
    try{
        const body={question:q};if(currentJobId)body.job_id=currentJobId;
        const r=await fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const el=$('typInd');if(el)el.remove();
        if(r.ok){const d=await r.json();addChat(d.answer||'No response.','assistant')}
        else{const e=await r.json();addChat('Error: '+(e.error||'Request failed'),'assistant')}
    }catch(e){const el=$('typInd');if(el)el.remove();addChat('Error: '+e.message,'assistant')}
    finally{chatBusy=false;$('chatSend').disabled=false;inp.focus()}
}
function addChat(text,role){const msgs=$('chatMsgs');const d=document.createElement('div');d.className='chat-msg '+role;d.textContent=text;msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight}

/* ─── Error ─── */
function showError(msg){showRpState(null);tabBar.classList.add('hidden');errorCard.classList.add('active');errorMsg.textContent=msg}
errorRetry.addEventListener('click',resetUI);

/* ─── Reset / New Project ─── */
function resetUI(){
    selectedFiles=[];buyoutFile=null;currentJobId=null;confirmedPrecheck=null;_scalarData=null;_resultsData=null;
    window._bbData=null;_procPages=0;_procTrades=0;
    fileList.innerHTML='';buyoutName.textContent='';buyoutRm.style.display='none';
    btnAnalyze.style.display='none';btnAnalyze.disabled=false;btnAnalyze.textContent='Analyze Documents';
    btnRerun.classList.add('hidden');btnNewProject.classList.add('hidden');
    lpUpload.classList.remove('hidden');lpProject.classList.add('hidden');
    lpScalars.classList.add('hidden');lpConfidence.classList.add('hidden');lpFlags.classList.add('hidden');
    $('lpFlagBadge').classList.add('hidden');
    tabBar.classList.add('hidden');errorCard.classList.remove('active');
    document.querySelectorAll('.tab-panel').forEach(p=>{p.classList.remove('active');p.innerHTML=''});
    showRpState('rpIdle');
}
btnNewProject.addEventListener('click',resetUI);
btnRerun.addEventListener('click',()=>{if(_scalarData){buildScalarsTab(_scalarData);showTab('scalars')}});

/* ─── Utility ─── */
function fmt(n){return n!=null?'$'+Math.round(n).toLocaleString():'\u2014'}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
})();
</script>
</body>
</html>
